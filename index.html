<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Dashboard</title>
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- Simple Login Page Style --- */
        #loginPage {
            position: fixed; 
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .login-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 320px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            text-align: center;
        }
        .login-box h2 { margin-bottom: 20px; }
        .login-box input {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            border: 1px solid #ccc;
        }
        .login-box button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        .login-error {
            margin-top: 10px;
            color: red;
            font-size: 14px;
            display:none;
        }

        /* Hide dashboard until login */
        #dashboard { display: none; }
    </style>
</head>
<body>

<!-- ===================== LOGIN PAGE ===================== -->
<div id="loginPage">
    <div class="login-box">
        <h2>Login</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
        <div class="login-error" id="loginError">Incorrect username or password</div>
    </div>
</div>
<!-- ===================================================== -->

<!-- Language Selection Modal -->
<div id="languageModal" class="modal">
    <div class="modal-content">
        <h2>Select Language / ·ûá·üí·ûö·ûæ·ûü·ûó·û∂·ûü·û∂</h2>
        <button id="langEn">English</button>
        <button id="langKh">·ûÅ·üí·ûò·üÇ·ûö</button>
    </div>
</div>

<!-- Notification Bar -->
<div id="notification-bar">Notification Message</div>

<!-- Dashboard -->
<div id="dashboard">

    <h1 data-en="Design ATS Remote Control with Safety Condition"
         data-kh="·ûö·ûÖ·ûì·û∂·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí·ûî·ûâ·üí·ûá·û∂·ûö ATS ·ûñ·û∏·ûÖ·ûò·üí·ûÑ·û∂·ûô·ûá·û∂·ûò·ûΩ·ûô·ûì·ûπ·ûÑ·ûõ·ûÄ·üí·ûÅ·ûÅ·ûé·üí·ûå·ûü·ûª·ûú·ûè·üí·ûê·û∑·ûó·û∂·ûñ"> 
        Power Monitoring Dashboard 
    </h1>

    <button id="changeLangBtn" 
        style="position: relative; float: right; margin-top: 20px; margin-bottom: 10px;
        padding: 8px 15px; border-radius: 8px; cursor: pointer;">
        Change Language
    </button>

    <div style="clear: both;"></div>

    <div id="connection" data-en="Status: Connected" data-kh="·ûü·üí·ûê·û∂·ûì·ûó·û∂·ûñ: ·ûè·ûó·üí·ûá·û∂·ûî·üã">Status: Connected</div>
    <div id="lastUpdate">Last Update: --:--:--</div>

    <!-- Display Section -->
    <div class="grid-display">
        <div class="card voltage" id="mainVoltageCard">
            <h3 data-en="Main Voltage" data-kh="·ûè·ûÑ·üã·ûü·üí·ûô·ûª·ûÑ·ûî·üí·ûö·ûó·ûñ·ûä·ûæ·ûò">Main Voltage</h3>
            <div id="mainVoltageValue">-- V</div>
        </div>

        <div class="card voltage" id="genVoltageCard">
            <h3 data-en="Gen Voltage" data-kh="·ûè·ûÑ·üã·ûü·üí·ûô·ûª·ûÑ·ûî·üí·ûö·ûó·ûñ·ûî·ûò·üí·ûö·ûª·ûÑ">Gen Voltage</h3>
            <div id="genVoltageValue">-- V</div>
        </div>

        <div class="card current">
            <h3 data-en="Current" data-kh="·û¢·üÜ·ûñ·üÇ">Current</h3>
            <div id="currentValue">-- A</div>
        </div>

        <div class="card lamp" id="mainLamp">
            <h3 data-en="Main Source" data-kh="·ûî·üí·ûö·ûó·ûñ·ûä·ûæ·ûò">Main Source</h3>
            <div class="lamp-signal off"></div>
        </div>

        <div class="card lamp" id="genLamp">
            <h3 data-en="Gen Source" data-kh="·ûî·üí·ûö·ûó·ûñ·ûî·ûò·üí·ûö·ûª·ûÑ">Gen Source</h3>
            <div class="lamp-signal off"></div>
        </div>

        <div class="card power">
            <h3 data-en="Power" data-kh="·û¢·û∂·ûì·ûª·ûó·û∂·ûñ">Power</h3>
            <div id="powerValue">-- kW</div>
        </div>

        <div class="card alarm ok alarm-big">
            <h3 data-en="Alarm" data-kh="Alarm">Alarm</h3>
            <div id="alarmStatus">OK</div>
        </div>
    </div>

    <!-- Control Buttons Section -->
    <h2 style="margin-top:40px; text-align:center;" 
        data-en="Control Buttons" data-kh="·ûï·üí·ûë·û∂·üÜ·ûÑ·ûî·ûâ·üí·ûá·û∂·ûî·üä·ûº·ûè·ûª·ûÑ">
        Control Buttons
    </h2>

    <div class="grid-buttons">
        <div class="card control" id="mainRelayCard">
            <h3 data-en="Main Relay" data-kh="·ûó·üí·ûá·û∂·ûî·üã·ûî·üí·ûö·ûó·ûñ·ûä·ûæ·ûò">Main Relay</h3>
            <button id="mainRelayBtn" class="stopped">OFF</button>
        </div>

        <div class="card control" id="genRelayCard">
            <h3 data-en="Gen Relay" data-kh="·ûó·üí·ûá·û∂·ûî·üã·ûî·üí·ûö·ûó·ûñ·ûî·ûò·üí·ûö·ûª·ûÑ">Gen Relay</h3>
            <button id="genRelayBtn" class="stopped">OFF</button>
        </div>

        <div class="card control gen-control-full" id="genControlCard">
            <h3 data-en="Generator Control" data-kh="·ûò·üâ·û∂·ûü·üä·û∏·ûì·ûó·üí·ûõ·ûæ·ûÑ">Generator Control</h3>
            <button id="genBtn" class="stopped" data-en="Start Generator" data-kh="·ûî·ûâ·üí·ûÜ·üÅ·üá·ûò·üâ·û∂·ûü·üä·û∏·ûì·ûó·üí·ûõ·ûæ·ûÑ">Start Generator</button>
        </div>
    </div>
</div>

<script>

    /* ====================== LOGIN SYSTEM ======================= */
    function login() {
        const user = document.getElementById("username").value;
        const pass = document.getElementById("password").value;
        const error = document.getElementById("loginError");

        if (user === "ATS" && pass === "1234") {
            document.getElementById("loginPage").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
        } else {
            error.style.display = "block";
        }
    }
    /* ============================================================ */

    /* ====================== LANGUAGE SYSTEM ===================== */
    const languageModal = document.getElementById('languageModal');
    const changeLangBtn = document.getElementById('changeLangBtn');

    function setLanguage(lang) {
        localStorage.setItem('lang', lang);
        document.querySelectorAll('[data-en]').forEach(el=>{
            el.textContent = lang==='en'? el.dataset.en : el.dataset.kh;
        });
        languageModal.style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
    }

    const savedLang = localStorage.getItem('lang');
    if(savedLang){ setLanguage(savedLang); }
    else { languageModal.style.display = 'flex'; }

    document.getElementById('langEn').addEventListener('click', ()=> setLanguage('en'));
    document.getElementById('langKh').addEventListener('click', ()=> setLanguage('kh'));
    changeLangBtn.addEventListener('click', ()=> languageModal.style.display = 'flex');

    /* ====================== BUTTON UI LOGIC ===================== */
    const genBtn = document.getElementById('genBtn');
    const genControlCard = document.getElementById('genControlCard');
    const mainRelayBtn = document.getElementById('mainRelayBtn');
    const genRelayBtn = document.getElementById('genRelayBtn');
    const mainRelayCard = document.getElementById('mainRelayCard');
    const genRelayCard = document.getElementById('genRelayCard');
    const mainLamp = document.querySelector('#mainLamp .lamp-signal');
    const genLamp = document.querySelector('#genLamp .lamp-signal');

    function setLamp(lamp, state) {
        if(state === 'on') { lamp.classList.add('on'); lamp.classList.remove('off'); }
        else { lamp.classList.add('off'); lamp.classList.remove('on'); }
    }

    showNotification('Dashboard Loaded', 'success');

</script>

<!-- MQTT SCRIPT (ONLY ONE!) -->
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>

    /* ===================== HiveMQ CLOUD MQTT ===================== */

    const broker = "wss://d16fd8e5e1dd4b009a2f258d647172ba.s1.eu.hivemq.cloud:8884/mqtt";

    const options = {
        username: "ATS_ESP",
        password: "ATS@esp32",
        reconnectPeriod: 2000,
        clean: true,
        keepalive: 60
    };

    const client = mqtt.connect(broker, options);

    client.on("connect", () => {
        console.log("üåê Connected to HiveMQ Cloud");
        showNotification("Connected to HiveMQ Cloud", "success");

        client.subscribe("ats/mainVoltage");
        client.subscribe("ats/genVoltage");
        client.subscribe("ats/current");
        client.subscribe("ats/mode");
    });

    client.on("message", (topic, msg) => {
        const data = msg.toString();

        if (topic === "ats/mainVoltage")
            mainVoltageValue.textContent = data + " V";

        if (topic === "ats/genVoltage")
            genVoltageValue.textContent = data + " V";

        if (topic === "ats/current")
            currentValue.textContent = data + " A";

        if (topic === "ats/mode") {
            if (data === "1") setLamp(mainLamp, "on");
            else setLamp(mainLamp, "off");

            if (data === "3") setLamp(genLamp, "on");
            else setLamp(genLamp, "off");
        }
    });

    function publish(topic, msg){
        if(client.connected){
            client.publish(topic, msg);
        }
    }

    genBtn.addEventListener('click', ()=>{
        const state = genBtn.classList.contains('stopped') ? "1" : "0";
        publish("ats/cmd/startGen", state);
    });

    mainRelayBtn.addEventListener('click', ()=>{
        const state = mainRelayBtn.classList.contains('stopped') ? "1" : "0";
        publish("ats/cmd/mainRelay", state);
    });

    genRelayBtn.addEventListener('click', ()=>{
        const state = genRelayBtn.classList.contains('stopped') ? "1" : "0";
        publish("ats/cmd/genRelay", state);
    });

</script>

</body>
</html>
